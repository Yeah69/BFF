<UserControl x:Class="BFF.WPFStuff.UserControls.TitDataGrid"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:lex="http://wpflocalizeextension.codeplex.com"
             lex:LocalizeDictionary.DesignCulture="en-US"
             lex:ResxLocalizationProvider.DefaultAssembly="BFF"
             lex:ResxLocalizationProvider.DefaultDictionary="Resources"
             xmlns:structure="clr-namespace:BFF.Model.Native.Structure"
             xmlns:native="clr-namespace:BFF.Model.Native"
             xmlns:converters="clr-namespace:BFF.WPFStuff.Converters"
             xmlns:validationRules="clr-namespace:BFF.WPFStuff.ValidationRules"
             xmlns:controls="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:userControls="clr-namespace:BFF.WPFStuff.UserControls"
             mc:Ignorable="d" 
             d:DesignWidth="1300" d:DesignHeight="700">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/controls.datagrid.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/controls.checkbox.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/controls.combobox.xaml" />
                <ResourceDictionary Source="/WPFStuff/Resources/TransUC_Icons.xaml" />
                <ResourceDictionary Source="/WPFStuff/Resources/BFF_ModifiedMAMComboBox.xaml" />
                <ResourceDictionary Source="/WPFStuff/Resources/BFF_ModifiedMAMCheckBox.xaml" />
                <ResourceDictionary Source="/WPFStuff/Resources/BFF_ResourceDictionary.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <converters:SumMultiConverter x:Key="SumMulti" PositiveBrush="{StaticResource BrushPositive}" NegativeBrush="{StaticResource BrushNegative}" TransferBrush="{StaticResource BrushTransfer}"/>
            <converters:TypeToBrushConverter x:Key="TypeToBrush" IncomeBrush="{StaticResource BrushPositive}" TransactionBrush="{StaticResource BrushNegative}" TransferBrush="{StaticResource BrushTransfer}"/>
            <converters:TypeToCanvasConverter x:Key="TypeToCanvas" IncomeCanvas="{StaticResource appbar_inbox_in}" TransactionCanvas="{StaticResource appbar_inbox_out}" TransferCanvas="{StaticResource appbar_arrow_left_right}"/>
            <converters:SubElementToSumConverter x:Key="SubElToSum"/>
            <converters:SubElementToSumPureConverter x:Key="SubElToSumPure"/>
            <converters:DepPropToUnsetConverter x:Key="DepPropToUnset"/>
        </ResourceDictionary>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <DataGrid Name="TitGrid" Grid.Row="0" ItemsSource="{Binding Tits}" AutoGenerateColumns="False">
            <DataGrid.Resources>
                <Style TargetType="ComboBox" BasedOn="{StaticResource MetroComboBox}">
                </Style>
            </DataGrid.Resources>
            <DataGrid.Style>
                <Style BasedOn="{StaticResource MetroDataGrid}"
                           TargetType="{x:Type DataGrid}">
                    <Setter Property="AlternatingRowBackground"
                                Value="{DynamicResource GrayBrush8}" />
                </Style>
            </DataGrid.Style>
            <DataGrid.Columns>
                <!-- Symbol -->
                <DataGridTemplateColumn Header="S">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Rectangle HorizontalAlignment="Center" VerticalAlignment="Center" Height="15" Width="15" Fill="{Binding Type, Converter={StaticResource TypeToBrush}}">
                                <Rectangle.OpacityMask>
                                    <VisualBrush Visual="{Binding Type, Converter={StaticResource TypeToCanvas}}" />
                                </Rectangle.OpacityMask>
                            </Rectangle>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <!-- Account -->
                <DataGridTemplateColumn Header="{lex:Loc Account}" SortMemberPath="Account.Name">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding}">
                                <ContentControl.Resources>
                                    <DataTemplate DataType="{x:Type structure:TitBase}">
                                        <TextBlock Text="{Binding Account}" />
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type native:Transfer}">
                                        <TextBlock Text="{lex:Loc Account_Transfer}" Foreground="{DynamicResource GrayBrush4}" />
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding}">
                                <ContentControl.Resources> 
                                    <DataTemplate DataType="{x:Type structure:TitBase}">
                                        <ComboBox TextSearch.TextPath="Name"
                                                              IsEditable="True"
                                                              IsTextSearchCaseSensitive="False"
                                                              IsTextSearchEnabled="True"
                                                              ItemsSource="{Binding DataContext.AllAccounts, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type controls:MetroWindow}}}">
                                            <ComboBox.SelectedItem>
                                                <Binding Path="Account" Mode="TwoWay" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validationRules:AccountRule />
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </ComboBox.SelectedItem>
                                        </ComboBox>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type native:Transfer}">
                                        <TextBlock Text="{lex:Loc Account_Transfer}" Foreground="{DynamicResource GrayBrush4}" />
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>
                <!-- Date -->
                <DataGridTextColumn Header="{lex:Loc Date}" Binding="{Binding Date, StringFormat=\{0:yy/MM/dd\}}"/>
                <!-- Payee -->
                <DataGridTemplateColumn Header="{lex:Loc Payee}" SortMemberPath="Payee.Name">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ContentControl HorizontalAlignment="Stretch"  Content="{Binding}">
                                <ContentControl.Resources>
                                    <DataTemplate DataType="{x:Type structure:TitBase}" >
                                        <TextBlock Text="{Binding Payee}" />
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type native:Transfer}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding FromAccount}" Foreground="{DynamicResource GrayBrush4}" />
                                            <Rectangle Margin="2,0,0,0" VerticalAlignment="Center" Height="15" Width="15" Fill="{DynamicResource GrayBrush4}">
                                                <Rectangle.OpacityMask>
                                                    <VisualBrush Visual="{DynamicResource appbar_layout_expand_right_variant}"/>
                                                </Rectangle.OpacityMask>
                                            </Rectangle>
                                        </StackPanel>
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ContentControl HorizontalAlignment="Stretch"  Content="{Binding}">
                                <ContentControl.Resources>
                                    <DataTemplate DataType="{x:Type structure:TitBase}" >
                                        <ComboBox TextSearch.TextPath="Name"
                                                              IsEditable="True"
                                                              IsTextSearchCaseSensitive="False"
                                                              IsTextSearchEnabled="True"
                                                              ItemsSource="{Binding DataContext.AllPayees, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type controls:MetroWindow}}}">
                                            <ComboBox.SelectedItem>
                                                <Binding Path="Payee" Mode="TwoWay" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validationRules:PayeeRule />
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </ComboBox.SelectedItem>
                                        </ComboBox>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type native:Transfer}">
                                        <ComboBox TextSearch.TextPath="Name"
                                                              IsEditable="True"
                                                              IsTextSearchCaseSensitive="False"
                                                              IsTextSearchEnabled="True"
                                                              ItemsSource="{Binding DataContext.AllAccounts, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type controls:MetroWindow}}}">
                                            <ComboBox.SelectedItem>
                                                <Binding Path="FromAccount" Mode="TwoWay" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validationRules:AccountRule />
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </ComboBox.SelectedItem>
                                        </ComboBox>
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>
                <!-- Category -->
                <DataGridTemplateColumn Header="{lex:Loc Category}" SortMemberPath="Category.Name">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding}">
                                <ContentControl.Resources>
                                    <DataTemplate DataType="{x:Type structure:TitBase}">
                                        <TextBlock Text="{Binding Category}" />
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type native:Transfer}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding ToAccount}" Foreground="{DynamicResource GrayBrush4}" />
                                            <Rectangle Margin="2,0,0,0" VerticalAlignment="Center" Height="15" Width="15" Fill="{DynamicResource GrayBrush4}">
                                                <Rectangle.OpacityMask>
                                                    <VisualBrush Visual="{DynamicResource appbar_layout_expand_right_variant}"/>
                                                </Rectangle.OpacityMask>
                                            </Rectangle>
                                        </StackPanel>
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding}">
                                <ContentControl.Resources>
                                    <HierarchicalDataTemplate DataType="{x:Type native:Category}" ItemsSource="{Binding Categories}">
                                        <TextBlock Text="{Binding}" />
                                    </HierarchicalDataTemplate>
                                    <DataTemplate DataType="{x:Type structure:TitBase}">
                                        <userControls:BFFTreeComboBox TextSearch.TextPath="Name"
                                                              ItemsSource="{Binding DataContext.AllCategoryRoots, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type controls:MetroWindow}}}">
                                            <userControls:BFFTreeComboBox.SelectedItem>
                                                <Binding Path="Category" Mode="TwoWay" UpdateSourceTrigger="PropertyChanged">
                                                    <!-- <Binding.ValidationRules>
                                                        <validationRules:AccountRule />
                                                    </Binding.ValidationRules> -->
                                                </Binding>
                                            </userControls:BFFTreeComboBox.SelectedItem>
                                        </userControls:BFFTreeComboBox>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type native:Transfer}">
                                        <ComboBox TextSearch.TextPath="Name"
                                                              IsEditable="True"
                                                              IsTextSearchCaseSensitive="False"
                                                              IsTextSearchEnabled="True"
                                                              ItemsSource="{Binding DataContext.AllAccounts, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type controls:MetroWindow}}}">
                                            <ComboBox.SelectedItem>
                                                <Binding Path="ToAccount" Mode="TwoWay" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validationRules:AccountRule />
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </ComboBox.SelectedItem>
                                        </ComboBox>
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>
                <!-- Memo -->
                <DataGridTemplateColumn Header="{lex:Loc Memo}" SortMemberPath="Memo" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding Memo, UpdateSourceTrigger=LostFocus}" ToolTip="{Binding Memo}" IsReadOnly="True" BorderThickness="0" Background="Transparent" LostFocus="TitGrid_TextBox_OnLostFocus" MouseDoubleClick="TitGrid_TextBox_OnMouseDoubleClick" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <!-- Sum -->
                <DataGridTemplateColumn Header="{lex:Loc Sum}" SortMemberPath="Sum" Width="Auto" IsReadOnly="False">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBox Name="TitGrid_SumBox" TextAlignment="Right" IsReadOnly="True" BorderThickness="0" Background="Transparent" LostFocus="TitGrid_TextBox_OnLostFocus" MouseDoubleClick="TitGrid_TextBox_OnMouseDoubleClick">
                                <TextBox.Foreground>
                                    <MultiBinding Converter="{StaticResource SumMulti}">
                                        <Binding Path="Sum" />
                                        <Binding Path="SubElements" Converter="{StaticResource SubElToSumPure}" />
                                        <Binding Path="Type" />
                                    </MultiBinding>
                                </TextBox.Foreground>
                                <TextBox.Text>
                                    <PriorityBinding FallbackValue="NaN">
                                        <Binding Path="Sum" Converter="{StaticResource DepPropToUnset}" Mode="TwoWay" UpdateSourceTrigger="LostFocus">
                                            <Binding.ValidationRules>
                                                <validationRules:CurrencyRule />
                                                <validationRules:CurrencyLongRangeRule />
                                            </Binding.ValidationRules>
                                        </Binding>
                                        <Binding Path="SubElements" Converter="{StaticResource SubElToSum}" Mode="TwoWay" StringFormat="C" />
                                    </PriorityBinding>
                                </TextBox.Text>
                            </TextBox>
                            <!-- todo: Maybe there is a better solution to the ConverterParameter problem -->
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <!-- Cleared -->
                <DataGridTemplateColumn Header="{lex:Loc Cleared}" SortMemberPath="Cleared" Width="Auto" IsReadOnly="True">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <CheckBox Style="{StaticResource BFFCheckBox}" IsChecked="{Binding Cleared, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" HorizontalAlignment="Center" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <!-- 
                        todo: (Payee, resolve problem with German Translation)
                     -->
            </DataGrid.Columns>
        </DataGrid>
        <GroupBox Grid.Row="1" Header="{lex:Loc TitView_BalanceDisplay}" HorizontalAlignment="Left">
            <TextBlock Name="TotalBalanceTextBlock"  Text="{Binding AccountBalance, Converter={StaticResource DepPropToUnset}}" />
        </GroupBox>
    </Grid>
</UserControl>
